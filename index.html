<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神の手 在庫管理システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2C3E50 0%, #34495E 50%, #3A506B 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* ログイン画面のスタイル */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .login-header {
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .login-header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .login-form {
            padding: 40px 30px;
        }
        
        .login-form-group {
            margin-bottom: 25px;
        }
        
        .login-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }
        
        .login-form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .login-form-group input:focus {
            outline: none;
            border-color: #FF6B35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.4);
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FF6B35;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* メイン画面のスタイル（既存のものをそのまま使用） */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .sync-status {
            position: absolute;
            top: 60px;
            right: 20px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .sync-connected {
            background: #28a745;
        }
        
        .sync-error {
            background: #dc3545;
        }
        
        .sync-loading {
            background: #ffc107;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #FF6B35;
        }
        
        .controls {
            padding: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            background: #fff;
            border-bottom: 1px solid #eee;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #FF6B35, #F7931E);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #FF6B6B, #ee5a52);
            color: white;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #FF6B35;
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        th {
            background: linear-gradient(45deg, #2C3E50, #34495E);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 15px 12px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.3s ease;
        }
        
        tr:hover td {
            background-color: #fafafa;
        }
        
        .expired {
            color: #dc3545 !important;
            font-weight: bold;
            background-color: #fff5f5 !important;
        }
        
        .warning {
            color: #fd7e14 !important;
            font-weight: bold;
        }
        
        .countdown {
            color: #dc3545 !important;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-refrigerated {
            background: #E8F5E8;
            color: #2E7D32;
        }
        
        .status-room {
            background: #FFF3E0;
            color: #F57C00;
        }
        
        .add-form {
            background: #f8f9fa;
            padding: 30px;
            border-top: 1px solid #eee;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #FF6B35;
        }
        
        .auto-field {
            background-color: #f8f9fa !important;
            color: #495057;
        }
        
        .action-btn {
            font-size: 12px;
            padding: 6px 12px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        
        .edit-btn {
            background: #34495E;
        }
        
        .delete-btn {
            background: #E74C3C;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .logout-btn {
                position: static;
                margin-top: 15px;
                display: block;
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- ログイン画面 -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1>🔥 神の手</h1>
            <p>在庫管理システム（クラウド版）</p>
        </div>
        <div class="login-form">
            <div class="error-message" id="errorMessage">
                パスワードが正しくありません
            </div>
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Airtableに接続中...</p>
            </div>
            <form onsubmit="handleLogin(event)" id="loginForm">
                <div class="login-form-group">
                    <label for="password">パスワード</label>
                    <input type="password" id="password" placeholder="パスワードを入力してください" required>
                </div>
                <button type="submit" class="login-btn">ログイン</button>
            </form>
        </div>
    </div>

    <!-- メイン画面 -->
    <div id="mainScreen" class="container hidden">
        <div class="header">
            <button class="logout-btn" onclick="logout()">ログアウト</button>
            <div class="sync-status" id="syncStatus">
                <span class="sync-indicator sync-connected"></span>
                クラウド同期中
            </div>
            <h1>🔥 神の手 在庫管理システム</h1>
            <p>廃棄ロス削減・効率的な在庫管理で利益アップ！</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalItems">0</div>
                <div>総在庫数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expiredItems">0</div>
                <div>期限切れ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="urgentItems">0</div>
                <div>24時間以内</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(45deg, #28a745, #20c997); color: white;">
                <div style="font-size: 1.5em;">☁️</div>
                <div>クラウド同期</div>
            </div>
        </div>
        
        <div class="controls">
            <input type="text" class="search-box" id="searchBox" placeholder="🔍 食材名で検索...">
            <select id="sortOptions" onchange="renderTable()" style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                <option value="default">並び順を選択</option>
                <option value="prepDate">入荷、仕込み日順</option>
                <option value="expiryDate">期限が短い順</option>
            </select>
            <button class="btn btn-primary" onclick="showAddForm()">➕ 新規追加</button>
            <button class="btn btn-success" onclick="exportToCSV()">📥 CSV出力</button>
            <button class="btn btn-danger" onclick="clearExpired()">🗑️ 期限切れ削除</button>
            <button class="btn" onclick="syncData()" style="background: #17a2b8; color: white;">🔄 同期</button>
        </div>
        
        <div class="table-container">
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>食材名</th>
                        <th>数量</th>
                        <th>入荷、仕込み日時</th>
                        <th>賞味期限</th>
                        <th>保存方法</th>
                        <th>保存場所</th>
                        <th>担当者</th>
                        <th>備考</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody">
                </tbody>
            </table>
        </div>
        
        <div class="add-form" id="addForm" style="display: none;">
            <h3>🆕 新しい食材を追加</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>食材名 <span style="color: #dc3545; font-weight: bold;">*</span></label>
                    <select id="itemName" onchange="calculateExpiry()" required>
                        <option value="">選択してください</option>
                        <optgroup label="野菜類">
                            <option value="もやし">もやし</option>
                            <option value="レタス">レタス</option>
                            <option value="キャベツ">キャベツ</option>
                        </optgroup>
                        <optgroup label="ラーメン">
                            <option value="味噌スープ">味噌スープ</option>
                        </optgroup>
                        <optgroup label="おつまみ、鉄板">
                            <option value="豚タン">豚タン</option>
                            <option value="チャーシュー">チャーシュー</option>
                            <option value="煮卵（悪魔の味玉）">煮卵（悪魔の味玉）</option>
                            <option value="焼きそば麺（味付き）">焼きそば麺（味付き）</option>
                            <option value="チャーハン">チャーハン</option>
                            <option value="餃子（鉄板焼き餃子）">餃子（鉄板焼き餃子）</option>
                            <option value="ガーリックシュリンプ">ガーリックシュリンプ</option>
                            <option value="イイダコ">イイダコ</option>
                            <option value="サラダ用野菜">サラダ用野菜</option>
                            <option value="ポテトサラダ">ポテトサラダ</option>
                            <option value="もやしナムル">もやしナムル</option>
                            <option value="玉こん酢味噌">玉こん酢味噌</option>
                            <option value="ピリ辛メンマ">ピリ辛メンマ</option>
                            <option value="梅クラゲ">梅クラゲ</option>
                            <option value="くらげ刺し">くらげ刺し</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label>数量 <span style="color: #dc3545; font-weight: bold;">*</span></label>
                    <input type="text" id="quantity" placeholder="例：1000g または 5個" required>
                </div>
                <div class="form-group">
                    <label>入荷、仕込み日時</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="datetime-local" id="prepDate" onchange="calculateExpiry()">
                        <button type="button" class="btn btn-primary" onclick="setCurrentTime()" style="white-space: nowrap; font-size: 12px; padding: 8px 16px;">現在の時刻</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>賞味期限</label>
                    <input type="datetime-local" id="expiryDate" class="auto-field">
                </div>
                <div class="form-group">
                    <label>保存方法</label>
                    <select id="storageType">
                        <option value="冷蔵">冷蔵</option>
                        <option value="常温">常温</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>保存場所</label>
                    <select id="location">
                        <option value="冷蔵庫1">冷蔵庫1</option>
                        <option value="冷蔵庫2">冷蔵庫2</option>
                        <option value="冷蔵庫3">冷蔵庫3</option>
                        <option value="冷蔵庫4">冷蔵庫4</option>
                        <option value="冷蔵庫5(ホール)">冷蔵庫5(ホール)</option>
                        <option value="冷蔵庫（倉庫）">冷蔵庫（倉庫）</option>
                        <option value="常温保管">常温保管</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>担当者 <span style="color: #dc3545; font-weight: bold;">*</span></label>
                    <select id="staff" required>
                        <option value="">選択してください</option>
                        <option value="後藤">後藤</option>
                        <option value="火山">火山</option>
                        <option value="原">原</option>
                        <option value="押尾">押尾</option>
                        <option value="綾樹">綾樹</option>
                        <option value="雅弥">雅弥</option>
                        <option value="さくら">さくら</option>
                        <option value="綾奈">綾奈</option>
                        <option value="晴喜">晴喜</option>
                        <option value="樹">樹</option>
                        <option value="美海">美海</option>
                        <option value="はるか">はるか</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>備考</label>
                    <input type="text" id="notes" placeholder="例：要注意、解凍済みなど">
                </div>
            </div>
            <button class="btn btn-success" id="submitBtn" onclick="addItem()">✅ 追加</button>
            <button class="btn" onclick="hideAddForm()" style="background: #6c757d; color: white; margin-left: 10px;">❌ キャンセル</button>
        </div>
    </div>

    <script>
        // Airtable設定 - 実際の値に変更してください
        const AIRTABLE_CONFIG = {
            apiKey: 'pat3bPDosx9aVpyns',
            baseId: 'appzhhT8Kt4LzgIJS',
            tableName: 'Inventory Items'
        };

        // パスワード認証
        const CORRECT_PASSWORD = 'haramika';
        let isLoggedIn = false;
        let inventory = [];
        let editingIndex = -1;
        let countdownInterval;

        // 食材ごとの消費期限データ（仕込み後・時間）
        const expiryHours = {
            // 野菜類
            "もやし": 24,
            "レタス": 48,
            "キャベツ": 72,
            
            // ラーメン
            "味噌スープ": 72,
            
            // おつまみ、鉄板
            "豚タン": 60,
            "チャーシュー": 72,
            "煮卵（悪魔の味玉）": 48,
            "焼きそば麺（味付き）": 36,
            "チャーハン": 36,
            "餃子（鉄板焼き餃子）": 12,
            "ガーリックシュリンプ": 24,
            "イイダコ": 24,
            "サラダ用野菜": 36,
            "ポテトサラダ": 48,
            "もやしナムル": 24,
            "玉こん酢味噌": 60,
            "ピリ辛メンマ": 120,
            "梅クラゲ": 168,
            "くらげ刺し": 12
        };

        // Airtable API関数
        async function callAirtableAPI(method, endpoint = '', data = null) {
            const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}${endpoint}`;
            
            const options = {
                method: method,
                headers: {
                    'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`Airtable API error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Airtable API Error:', error);
                updateSyncStatus('error');
                throw error;
            }
        }

        // データ同期関数
        async function loadFromAirtable() {
            try {
                updateSyncStatus('loading');
                const response = await callAirtableAPI('GET');
                
                inventory = response.records.map(record => ({
                    id: record.id,
                    name: record.fields['Item Name'] || '',
                    quantity: record.fields['Quantity'] || '',
                    prepDate: record.fields['Prep Date'] || '',
                    expiryDate: record.fields['Expiration Date'] || '',
                    storageType: record.fields['Storage Type'] || '冷蔵',
                    location: record.fields['Storage Location'] || '',
                    staff: record.fields['Staff'] || '',
                    notes: record.fields['Notes'] || ''
                }));
                
                updateSyncStatus('connected');
                return true;
            } catch (error) {
                console.error('データ読み込みエラー:', error);
                updateSyncStatus('error');
                return false;
            }
        }

        async function saveToAirtable(item) {
            try {
                updateSyncStatus('loading');
                
                const airtableFields = {
                    'Item Name': item.name,
                    'Quantity': item.quantity,
                    'Prep Date': item.prepDate,
                    'Expiration Date': item.expiryDate,
                    'Storage Type': item.storageType,
                    'Storage Location': item.location,
                    'Staff': item.staff,
                    'Notes': item.notes
                };

                const data = {
                    fields: airtableFields
                };

                if (item.id) {
                    // 更新
                    await callAirtableAPI('PATCH', `/${item.id}`, data);
                } else {
                    // 新規作成
                    const response = await callAirtableAPI('POST', '', data);
                    item.id = response.id;
                }
                
                updateSyncStatus('connected');
                return true;
            } catch (error) {
                console.error('データ保存エラー:', error);
                updateSyncStatus('error');
                return false;
            }
        }

        async function deleteFromAirtable(itemId) {
            try {
                updateSyncStatus('loading');
                await callAirtableAPI('DELETE', `/${itemId}`);
                updateSyncStatus('connected');
                return true;
            } catch (error) {
                console.error('データ削除エラー:', error);
                updateSyncStatus('error');
                return false;
            }
        }

        // 同期ステータス更新
        function updateSyncStatus(status) {
            const syncStatus = document.getElementById('syncStatus');
            const indicator = syncStatus.querySelector('.sync-indicator');
            
            indicator.className = 'sync-indicator';
            
            switch (status) {
                case 'connected':
                    indicator.classList.add('sync-connected');
                    syncStatus.innerHTML = '<span class="sync-indicator sync-connected"></span>クラウド同期済み';
                    break;
                case 'loading':
                    indicator.classList.add('sync-loading');
                    syncStatus.innerHTML = '<span class="sync-indicator sync-loading"></span>同期中...';
                    break;
                case 'error':
                    indicator.classList.add('sync-error');
                    syncStatus.innerHTML = '<span class="sync-indicator sync-error"></span>同期エラー';
                    break;
            }
        }

        // 手動同期
        async function syncData() {
            await loadFromAirtable();
            renderTable();
        }

        // ログイン機能
        async function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const loginContainer = document.querySelector('.login-container');
            const loginForm = document.getElementById('loginForm');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            if (password === CORRECT_PASSWORD) {
                // パスワード正確、Airtable接続開始
                loginForm.style.display = 'none';
                loadingSpinner.style.display = 'block';
                
                // 実際のAPIキーに置き換える（デモ用の処理）
                if (AIRTABLE_CONFIG.apiKey === 'YOUR_AIRTABLE_API_TOKEN_HERE') {
                    // APIキーが設定されていない場合の処理
                    setTimeout(() => {
                        loadingSpinner.style.display = 'none';
                        loginForm.style.display = 'block';
                        errorMessage.textContent = 'Airtable APIキーが設定されていません';
                        errorMessage.style.display = 'block';
                        setTimeout(() => {
                            errorMessage.style.display = 'none';
                        }, 5000);
                    }, 2000);
                    return;
                }
                
                // Airtableからデータを読み込み
                const success = await loadFromAirtable();
                
                if (success) {
                    isLoggedIn = true;
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainScreen').classList.remove('hidden');
                    
                    renderTable();
                    startCountdownTimer();
                } else {
                    loadingSpinner.style.display = 'none';
                    loginForm.style.display = 'block';
                    errorMessage.textContent = 'Airtableへの接続に失敗しました';
                    errorMessage.style.display = 'block';
                    setTimeout(() => {
                        errorMessage.style.display = 'none';
                    }, 5000);
                }
            } else {
                // パスワード不正
                errorMessage.textContent = 'パスワードが正しくありません';
                errorMessage.style.display = 'block';
                loginContainer.classList.add('shake');
                document.getElementById('password').value = '';
                
                setTimeout(() => {
                    loginContainer.classList.remove('shake');
                }, 500);
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 3000);
            }
        }

        function logout() {
            if (confirm('ログアウトしますか？')) {
                isLoggedIn = false;
                document.getElementById('mainScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
                
                document.getElementById('password').value = '';
                hideAddForm();
            }
        }

        // 時刻関連の関数
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'Asia/Tokyo'
            });
        }

        function calculateExpiry() {
            const itemName = document.getElementById('itemName').value;
            const prepDateInput = document.getElementById('prepDate');
            const expiryDateInput = document.getElementById('expiryDate');
            
            if (!itemName || !prepDateInput.value) {
                expiryDateInput.value = '';
                return;
            }
            
            const hours = expiryHours[itemName] || 72;
            const prepDate = new Date(prepDateInput.value);
            const expiryDate = new Date(prepDate.getTime() + (hours * 60 * 60 * 1000));
            
            const year = expiryDate.getFullYear();
            const month = String(expiryDate.getMonth() + 1).padStart(2, '0');
            const day = String(expiryDate.getDate()).padStart(2, '0');
            const hour = String(expiryDate.getHours()).padStart(2, '0');
            const minute = String(expiryDate.getMinutes()).padStart(2, '0');
            
            const localTimeString = `${year}-${month}-${day}T${hour}:${minute}`;
            expiryDateInput.value = localTimeString;
        }

        function setCurrentTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const timeString = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('prepDate').value = timeString;
            calculateExpiry();
        }

        function getTimeUntilExpiry(expiryDate) {
            const now = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - now;
            
            if (diffTime <= 0) {
                return { expired: true, text: "期限切れ" };
            }
            
            const totalSeconds = Math.floor(diffTime / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours < 24) {
                const hoursStr = String(hours).padStart(2, '0');
                const minutesStr = String(minutes).padStart(2, '0');
                const secondsStr = String(seconds).padStart(2, '0');
                return { 
                    urgent: true, 
                    text: `残り${hoursStr}:${minutesStr}:${secondsStr}`,
                    totalSeconds: totalSeconds
                };
            }
            
            const days = Math.floor(hours / 24);
            const remainingHours = hours % 24;
            
            if (days === 0) {
                return { text: `${remainingHours}時間` };
            } else if (days === 1) {
                return { warning: true, text: `${days}日${remainingHours}時間` };
            } else {
                return { text: `${days}日${remainingHours}時間` };
            }
        }

        function getStatusClass(expiryDate) {
            const timeInfo = getTimeUntilExpiry(expiryDate);
            if (timeInfo.expired) return 'expired';
            if (timeInfo.urgent) return 'countdown';
            if (timeInfo.warning) return 'warning';
            return '';
        }

        function getStorageBadge(storageType) {
            const badges = {
                '冷蔵': 'status-refrigerated',
                '常温': 'status-room'
            };
            return `<span class="status-badge ${badges[storageType] || ''}">${storageType}</span>`;
        }

        // テーブル描画
        function renderTable() {
            if (!isLoggedIn) return;
            
            const tbody = document.getElementById('inventoryBody');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const sortOption = document.getElementById('sortOptions').value;
            
            let filteredInventory = inventory.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.notes.toLowerCase().includes(searchTerm)
            );

            if (sortOption === 'prepDate') {
                filteredInventory.sort((a, b) => new Date(a.prepDate) - new Date(b.prepDate));
            } else if (sortOption === 'expiryDate') {
                filteredInventory.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
            }

            tbody.innerHTML = '';
            filteredInventory.forEach((item, index) => {
                const timeInfo = getTimeUntilExpiry(item.expiryDate);
                const statusClass = getStatusClass(item.expiryDate);
                const originalIndex = inventory.indexOf(item);
                const row = document.createElement('tr');
                
                let expiryDisplay = formatDateTime(item.expiryDate);
                if (timeInfo.urgent || timeInfo.expired) {
                    expiryDisplay += `<br><span class="${statusClass}">${timeInfo.text}</span>`;
                }
                
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${formatDateTime(item.prepDate)}</td>
                    <td>${expiryDisplay}</td>
                    <td>${getStorageBadge(item.storageType)}</td>
                    <td>${item.location}</td>
                    <td>${item.staff}</td>
                    <td>${item.notes}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editItem(${originalIndex})">編集</button>
                        <button class="action-btn delete-btn" onclick="deleteItem(${originalIndex})">削除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updateStats();
        }

        function updateStats() {
            if (!isLoggedIn) return;
            
            const total = inventory.length;
            const expired = inventory.filter(item => getTimeUntilExpiry(item.expiryDate).expired).length;
            const urgent = inventory.filter(item => getTimeUntilExpiry(item.expiryDate).urgent).length;

            document.getElementById('totalItems').textContent = total;
            document.getElementById('expiredItems').textContent = expired;
            document.getElementById('urgentItems').textContent = urgent;
        }

        // フォーム管理
        function showAddForm() {
            document.getElementById('addForm').style.display = 'block';
            document.getElementById('prepDate').value = '';
            document.getElementById('expiryDate').value = '';
        }

        function hideAddForm() {
            document.getElementById('addForm').style.display = 'none';
            clearForm();
            editingIndex = -1;
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = '✅ 追加';
            submitBtn.onclick = addItem;
        }

        function clearForm() {
            document.getElementById('itemName').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('prepDate').value = '';
            document.getElementById('expiryDate').value = '';
            document.getElementById('storageType').value = '冷蔵';
            document.getElementById('location').value = '冷蔵庫1';
            document.getElementById('staff').value = '';
            document.getElementById('notes').value = '';
        }

        async function addItem() {
            const newItem = {
                name: document.getElementById('itemName').value,
                quantity: document.getElementById('quantity').value,
                prepDate: document.getElementById('prepDate').value,
                expiryDate: document.getElementById('expiryDate').value,
                storageType: document.getElementById('storageType').value,
                location: document.getElementById('location').value,
                staff: document.getElementById('staff').value,
                notes: document.getElementById('notes').value
            };

            if (!newItem.name || !newItem.quantity || !newItem.staff) {
                alert('食材名、数量、担当者は必須項目です。');
                return;
            }

            if (editingIndex >= 0) {
                newItem.id = inventory[editingIndex].id;
                inventory[editingIndex] = newItem;
            } else {
                inventory.push(newItem);
            }
            
            // Airtableに保存
            const success = await saveToAirtable(newItem);
            if (success) {
                renderTable();
                hideAddForm();
            } else {
                alert('データの保存に失敗しました。再度お試しください。');
            }
        }

        async function deleteItem(index) {
            if (confirm('この食材を削除しますか？')) {
                const item = inventory[index];
                
                // Airtableから削除
                if (item.id) {
                    const success = await deleteFromAirtable(item.id);
                    if (!success) {
                        alert('データの削除に失敗しました。');
                        return;
                    }
                }
                
                inventory.splice(index, 1);
                renderTable();
            }
        }

        function editItem(index) {
            const item = inventory[index];
            editingIndex = index;
            
            document.getElementById('itemName').value = item.name;
            document.getElementById('quantity').value = item.quantity;
            document.getElementById('prepDate').value = item.prepDate;
            document.getElementById('expiryDate').value = item.expiryDate;
            document.getElementById('storageType').value = item.storageType;
            document.getElementById('location').value = item.location;
            document.getElementById('staff').value = item.staff;
            document.getElementById('notes').value = item.notes;
            
            showAddForm();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = '✅ 更新';
            submitBtn.onclick = addItem;
        }

        async function clearExpired() {
            if (confirm('期限切れの食材をすべて削除しますか？')) {
                const expiredItems = inventory.filter(item => getTimeUntilExpiry(item.expiryDate).expired);
                
                for (const item of expiredItems) {
                    if (item.id) {
                        await deleteFromAirtable(item.id);
                    }
                }
                
                inventory = inventory.filter(item => !getTimeUntilExpiry(item.expiryDate).expired);
                renderTable();
            }
        }

        function exportToCSV() {
            const headers = ['食材名', '数量', '入荷、仕込み日時', '賞味期限', '保存方法', '保存場所', '担当者', '備考'];
            const csvContent = [
                headers.join(','),
                ...inventory.map(item => [
                    item.name,
                    item.quantity,
                    formatDateTime(item.prepDate),
                    formatDateTime(item.expiryDate),
                    item.storageType,
                    item.location,
                    item.staff,
                    item.notes
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '神の手_在庫管理_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function startCountdownTimer() {
            countdownInterval = setInterval(() => {
                renderTable();
            }, 1000);
        }

        // 検索機能
        document.getElementById('searchBox').addEventListener('input', renderTable);

        // Enterキーでログイン
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin(e);
            }
        });

        // 初期表示
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainScreen').classList.add('hidden');
        });
    </script>
</body>
</html>
